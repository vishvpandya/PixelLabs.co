<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PixelLabs Admin</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{--bg:#0b0b0b;--card:#121212;--text:#f5f5f5;--muted:#aaa;--accent:#8ab4ff;--border:#222}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:16px}
    .two{grid-template-columns:1fr 2fr}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    h1{margin:8px 0 16px} h2{margin:0 0 12px;font-size:18px}
    label{font-size:13px;color:var(--muted)} input,textarea,button,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0e0e0e;color:var(--text)}
    button{cursor:pointer;border:1px solid #1f1f1f}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .img-preview{width:100%;max-width:220px;aspect-ratio:1/1;object-fit:cover;border-radius:14px;border:1px dashed var(--border)}
    .list{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:60px 1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px}
    .item img{width:60px;height:60px;object-fit:cover;border-radius:10px}
    .pill{font-size:12px;color:#111;background:var(--accent);padding:4px 8px;border-radius:999px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üõ†Ô∏è PixelLabs Admin</h1>

    <!-- LOGIN -->
    <div id="auth" class="card">
      <h2>Login</h2>
      <div class="row">
        <input id="email" type="email" placeholder="admin email" />
        <input id="password" type="password" placeholder="password" />
        <button id="loginBtn">Login</button>
        <button id="logoutBtn" style="display:none">Logout</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:8px"></div>
    </div>

    <div id="app" style="display:none" class="grid" >
      <div class="grid two">
        <!-- SITE SETTINGS -->
        <div class="card">
          <h2>Site Settings</h2>
          <div class="grid" style="gap:12px">
            <div>
              <label>Logo</label>
              <img id="logoPreview" class="img-preview" src="" alt="Logo preview"/>
              <input id="logoFile" type="file" accept="image/*" />
              <button id="saveLogo">Upload Logo</button>
            </div>
            <div>
              <label>Profile Picture</label>
              <img id="pfpPreview" class="img-preview" src="" alt="Profile preview"/>
              <input id="pfpFile" type="file" accept="image/*" />
              <button id="savePfp">Upload Profile Picture</button>
            </div>
          </div>
          <div style="margin-top:12px">
            <label>Short Description</label>
            <textarea id="shortDesc" rows="3" placeholder="Write a short description..."></textarea>
            <button id="saveDesc" style="margin-top:8px">Save Description</button>
          </div>
        </div>

        <!-- ADD / EDIT PRODUCT -->
        <div class="card">
          <h2>Add / Edit Product</h2>
          <div class="grid" style="gap:10px">
            <input id="pName" placeholder="Product name" />
            <input id="pPrice" type="number" step="0.01" placeholder="Price" />
            <div class="row">
              <input id="pSort" type="number" placeholder="Sort order (0..100)" />
              <select id="pActive">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
            <div>
              <label>Product Image</label>
              <img id="pImgPreview" class="img-preview" src="" alt="Product preview"/>
              <input id="pImgFile" type="file" accept="image/*" />
            </div>
            <div class="row">
              <button id="addProduct">Add Product</button>
              <button id="updateProduct" disabled>Update Selected</button>
              <button id="resetForm">Reset</button>
            </div>
            <div id="formMsg" class="muted"></div>
          </div>
        </div>
      </div>

      <!-- PRODUCTS LIST -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Products</h2>
          <span class="pill" id="count">0 items</span>
        </div>
        <div id="products" class="list"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://supabase.com/dashboard/project/xrykrodzocxzhqbxxntk";             // e.g. https://abcd.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhyeWtyb2R6b2N4emhxYnh4bnRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0MzEwNDcsImV4cCI6MjA3MTAwNzA0N30.dxUWCPCnSwNiVwFWhl1vabOn1bdtayocZV5Uor2MO7k";    // from your project settings
    const BUCKET = 'images';
    const s = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);

    // Auth
    async function refreshSession() {
      const { data: { session } } = await s.auth.getSession();
      toggleApp(!!session);
      if (session) { loadAll(); }
    }
    function toggleApp(on){
      $('app').style.display = on ? 'grid' : 'none';
      $('logoutBtn').style.display = on ? 'inline-block' : 'none';
    }
    $('loginBtn').onclick = async () => {
      const email = $('email').value.trim();
      const password = $('password').value.trim();
      const { error } = await s.auth.signInWithPassword({ email, password });
      $('authMsg').textContent = error ? error.message : 'Logged in';
      refreshSession();
    };
    $('logoutBtn').onclick = async () => { await s.auth.signOut(); refreshSession(); };

    // Helpers
    const toPublicURL = (path) => s.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;
    async function uploadFile(file){
      const ext = file.name.split('.').pop();
      const key = `${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
      const { error } = await s.storage.from(BUCKET).upload(key, file, { upsert:false });
      if (error) throw error; return toPublicURL(key);
    }

    // Load settings
    async function loadSettings(){
      const { data } = await s.from('site_settings').select('*').eq('id',1).single();
      if (!data) return;
      $('shortDesc').value = data.short_description || '';
      if (data.logo_url) $('logoPreview').src = data.logo_url;
      if (data.profile_pic_url) $('pfpPreview').src = data.profile_pic_url;
    }

    // Save settings
    $('saveLogo').onclick = async () => {
      const f = $('logoFile').files[0]; if (!f) return alert('Choose a logo file');
      try {
        const url = await uploadFile(f);
        await s.from('site_settings').update({ logo_url:url, updated_at:new Date().toISOString() }).eq('id',1);
        $('logoPreview').src = url; alert('Logo updated');
      } catch(e){ alert(e.message); }
    };
    $('savePfp').onclick = async () => {
      const f = $('pfpFile').files[0]; if (!f) return alert('Choose a profile picture');
      try {
        const url = await uploadFile(f);
        await s.from('site_settings').update({ profile_pic_url:url, updated_at:new Date().toISOString() }).eq('id',1);
        $('pfpPreview').src = url; alert('Profile picture updated');
      } catch(e){ alert(e.message); }
    };
    $('saveDesc').onclick = async () => {
      const text = $('shortDesc').value;
      await s.from('site_settings').update({ short_description:text, updated_at:new Date().toISOString() }).eq('id',1);
      alert('Description saved');
    };

    // Products
    let editingId = null, currentImageURL = '';

    function productRow(p){
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <img src="${p.image_url || ''}" alt=""/>
        <div>
          <div><strong>${p.name}</strong> <span class="muted">‚Çπ${Number(p.price||0).toFixed(2)}</span></div>
          <div class="muted">Sort: ${p.sort_order ?? 0} ‚Ä¢ ${p.active ? 'Active' : 'Inactive'}</div>
        </div>
        <div class="row" style="gap:6px; width:200px">
          <button data-edit="${p.id}">Edit</button>
          <button data-del="${p.id}">Delete</button>
        </div>`;
      return el;
    }

    async function loadProducts(){
      const { data } = await s.from('products').select('*').order('sort_order', { ascending:true }).order('created_at', { ascending:false });
      const box = $('products'); box.innerHTML = '';
      (data||[]).forEach(p => box.appendChild(productRow(p)));
      $('count').textContent = `${(data||[]).length} items`;

      box.querySelectorAll('button[data-edit]').forEach(btn => btn.onclick = async () => {
        const id = Number(btn.dataset.edit);
        const { data: one } = await s.from('products').select('*').eq('id', id).single();
        if (!one) return;
        editingId = id; currentImageURL = one.image_url || '';
        $('pName').value = one.name || '';
        $('pPrice').value = one.price || 0;
        $('pSort').value = one.sort_order || 0;
        $('pActive').value = String(!!one.active);
        $('pImgPreview').src = one.image_url || '';
        $('updateProduct').disabled = false;
        $('formMsg').textContent = `Editing product #${id}`;
      });

      box.querySelectorAll('button[data-del]').forEach(btn => btn.onclick = async () => {
        const id = Number(btn.dataset.del);
        if (!confirm('Delete this product?')) return;
        await s.from('products').delete().eq('id', id);
        loadProducts();
      });
    }

    $('pImgFile').onchange = (e) => {
      const f = e.target.files[0]; if (!f) return;
      const reader = new FileReader(); reader.onload = (ev)=> $('pImgPreview').src = ev.target.result; reader.readAsDataURL(f);
    };

    $('addProduct').onclick = async () => {
      try{
        let url = currentImageURL; const f = $('pImgFile').files[0]; if (f) url = await uploadFile(f);
        const row = {
          name: $('pName').value.trim(),
          price: Number($('pPrice').value||0),
          sort_order: Number($('pSort').value||0),
          active: $('pActive').value === 'true',
          image_url: url
        };
        if (!row.name) return alert('Name required');
        await s.from('products').insert(row);
        $('formMsg').textContent = 'Product added';
        resetForm();
        loadProducts();
      }catch(e){ alert(e.message); }
    };

    $('updateProduct').onclick = async () => {
      if (!editingId) return;
      try{
        let url = currentImageURL; const f = $('pImgFile').files[0]; if (f) url = await uploadFile(f);
        const row = {
          name: $('pName').value.trim(),
          price: Number($('pPrice').value||0),
          sort_order: Number($('pSort').value||0),
          active: $('pActive').value === 'true',
          image_url: url,
          updated_at: new Date().toISOString()
        };
        await s.from('products').update(row).eq('id', editingId);
        $('formMsg').textContent = 'Product updated';
        resetForm();
        loadProducts();
      }catch(e){ alert(e.message); }
    };

    $('resetForm').onclick = resetForm;
    function resetForm(){
      editingId = null; currentImageURL = '';
      $('pName').value = '';
      $('pPrice').value = '';
      $('pSort').value = '0';
      $('pActive').value = 'true';
      $('pImgFile').value = '';
      $('pImgPreview').src = '';
      $('updateProduct').disabled = true;
      $('formMsg').textContent = '';
    }

    async function loadAll(){
      await loadSettings();
      await loadProducts();
    }

    // Initial
    refreshSession();
  </script>
</body>
</html>